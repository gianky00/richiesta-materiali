@echo off
echo ========================================================
echo      RDA VIEWER - AUTOMATED RELEASE
echo ========================================================
set VENV_DIR=.venv

:: 1. Environment Prep (VENV)
echo [1/5] Checking Environment (%VENV_DIR%)...
if not exist "%VENV_DIR%\Scripts\activate.bat" (
    if exist "%VENV_DIR%" (
        echo Corrupt venv detected. Cleaning...
        rmdir /s /q "%VENV_DIR%"
    )
    echo Creating virtual environment...
    python -m venv %VENV_DIR%

    if not exist "%VENV_DIR%\Scripts\activate.bat" (
        echo ERROR: Could not create virtual environment. Check Python installation.
        pause
        exit /b 1
    )
)
call "%VENV_DIR%\Scripts\activate.bat"

echo Updating dependencies...
pip install --upgrade pip
pip install -r requirements.txt
if %errorlevel% neq 0 (
    echo Error installing dependencies!
    pause
    exit /b %errorlevel%
)

:: 2. Bump Version
echo.
echo [2/5] Incrementing Patch Version...
python admin/bump_version.py patch
if %errorlevel% neq 0 (
    echo Error bumping version!
    pause
    exit /b %errorlevel%
)

:: 3. Build & Deploy
echo.
echo [3/5] Building Application and Installer...
echo This may take a few minutes...
python admin/build_dist.py
if %errorlevel% neq 0 (
    echo Error during build/deploy process!
    pause
    exit /b %errorlevel%
)

:: 4. Finalizing
echo.
echo [4/5] Release Process Completed!
echo.
echo New version is live on Netlify.
pause
